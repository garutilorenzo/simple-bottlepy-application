version: '3.4'
services:

  bottle:
    image: bottle-be:dev
    build:
     context: bottle/
     args:
       - http_proxy=$http_proxy
       - https_proxy=$http_proxy
    container_name: bottle
    environment:
      - PATH=$PATH:/app/.local/bin/
      - PYTHONPATH=$PYTHONPATH:/app/src
      - BOTTLE_APP_ENVIRONMENT=dev
      - BOTTLE_APP_NAME=bottle
      - ROM_REDIS_URI=redis://@redis:6379
    volumes:
      - ./src:/app/src
      - ./data:/data
    command: ['python', 'bottle/app_redis.py']
    ports:
      - 8080:8080
    depends_on:
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "5"
    restart: always

  redis:
    image: redislabs/redismod:latest
    container_name: redismod
    volumes:
      - type: volume
        source: redis
        target: /data
      - type: bind
        source: ./conf/redis.conf
        target: /usr/local/etc/redis/redis.conf
    command:  >
      /usr/local/etc/redis/redis.conf
      --loadmodule /usr/lib/redis/modules/redisai.so
      --loadmodule /usr/lib/redis/modules/redisearch.so
      --loadmodule /usr/lib/redis/modules/redisgraph.so  
      --loadmodule /usr/lib/redis/modules/redistimeseries.so
      --loadmodule /usr/lib/redis/modules/rejson.so
      --loadmodule /usr/lib/redis/modules/redisbloom.so  
      --loadmodule /usr/lib/redis/modules/redisgears.so  
      Plugin /var/opt/redislabs/modules/rg/plugin/gears_python.so
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "5"
    restart: always

volumes:
  postgres:
  redis: